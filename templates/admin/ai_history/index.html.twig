{% extends 'admin/base.html.twig' %}

{% set page_title = 'Historique AI' %}
{% set page_subtitle = 'Suivi des prompts, intentions, latence et reponses.' %}
{% set active_menu = 'ai_history' %}

{% block admin_content %}
    <section class="admin-card">
        <div class="admin-card__header">
            <h2 class="admin-card__title">Filtres</h2>
            <p class="admin-card__subtitle">Affiner les logs IA.</p>
        </div>
        <div class="admin-card__body">
            <form class="admin-form admin-form--inline" method="get" action="{{ path('admin_ai_history') }}">
                <div class="admin-form__field">
                    <label class="admin-form__label" for="ai-history-success">Succes</label>
                    <select class="admin-form__select" id="ai-history-success" name="success">
                        <option value="" {{ filters.success == '' ? 'selected' : '' }}>Tous</option>
                        <option value="1" {{ filters.success == '1' ? 'selected' : '' }}>Oui</option>
                        <option value="0" {{ filters.success == '0' ? 'selected' : '' }}>Non</option>
                    </select>
                </div>
                <div class="admin-form__field">
                    <label class="admin-form__label" for="ai-history-intent">Intent</label>
                    <input class="admin-form__input" id="ai-history-intent" name="intent" value="{{ filters.intent }}" placeholder="informative" />
                </div>
                <div class="admin-form__field">
                    <label class="admin-form__label" for="ai-history-slug">Slug</label>
                    <input class="admin-form__input" id="ai-history-slug" name="slug" value="{{ filters.slug }}" placeholder="prompt_slug" />
                </div>
                <div class="admin-form__field">
                    <label class="admin-form__label" for="ai-history-from">Du</label>
                    <input class="admin-form__input" id="ai-history-from" name="from" type="date" value="{{ filters.from }}" />
                </div>
                <div class="admin-form__field">
                    <label class="admin-form__label" for="ai-history-to">Au</label>
                    <input class="admin-form__input" id="ai-history-to" name="to" type="date" value="{{ filters.to }}" />
                </div>
                <div class="admin-form__field">
                    <label class="admin-form__label" for="ai-history-limit">Page</label>
                    <input class="admin-form__input" id="ai-history-limit" name="limit" type="number" min="5" max="100" value="{{ limit }}" />
                </div>
                <button class="admin-button admin-button--primary" type="submit">Filtrer</button>
            </form>
        </div>
    </section>

    <section class="admin-card">
        <div class="admin-card__header">
            <h2 class="admin-card__title">Historique</h2>
            <p class="admin-card__subtitle">{{ total }} entree(s)</p>
        </div>
        <div class="admin-card__body">
            <div class="admin-table-wrap">
                <table class="admin-table">
                    <thead>
                        <tr class="admin-table__row">
                            <th class="admin-table__cell">Date</th>
                            <th class="admin-table__cell">Version</th>
                            <th class="admin-table__cell">Intent</th>
                            <th class="admin-table__cell">Succes</th>
                            <th class="admin-table__cell">Latence</th>
                            <th class="admin-table__cell">Modele</th>
                            <th class="admin-table__cell">Prompt client</th>
                            <th class="admin-table__cell">Final prompt</th>
                            <th class="admin-table__cell">Keys</th>
                            <th class="admin-table__cell">Keys validees</th>
                            <th class="admin-table__cell">Constraints</th>
                            <th class="admin-table__cell admin-table__cell--actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for history in histories %}
                            <tr class="admin-table__row">
                                <td class="admin-table__cell admin-table__cell--mono">
                                    <a href="{{ path('admin_ai_history_show', {id: history.id}) }}"
                                       data-ai-history-view
                                       data-history-url="{{ path('admin_ai_history_json', {id: history.id}) }}">
                                        {{ history.createdAt|date('Y-m-d H:i') }}
                                    </a>
                                </td>
                                <td class="admin-table__cell admin-table__cell--mono">{{ history.promptVersion ?? '-' }}</td>
                                <td class="admin-table__cell">{{ history.intent ?? '-' }}</td>
                                <td class="admin-table__cell">{{ history.success ? 'oui' : 'non' }}</td>
                                <td class="admin-table__cell admin-table__cell--mono">{{ history.latencyMs ?? '-' }}</td>
                                <td class="admin-table__cell admin-table__cell--mono">{{ history.modelName ?? '-' }}</td>
                                {% set promptClient = history.promptClient ?? '' %}
                                <td class="admin-table__cell admin-table__cell--truncate" data-tooltip="{{ promptClient|e('html_attr') }}">
                                    {{ promptClient|length > 80 ? promptClient|slice(0, 80) ~ '…' : (promptClient != '' ? promptClient : '-') }}
                                </td>
                                {% set finalPrompt = history.finalPrompt ?? '' %}
                                <td class="admin-table__cell admin-table__cell--truncate" data-tooltip="{{ finalPrompt|e('html_attr') }}">
                                    {{ finalPrompt|length > 80 ? finalPrompt|slice(0, 80) ~ '…' : (finalPrompt != '' ? finalPrompt : '-') }}
                                </td>
                                <td class="admin-table__cell admin-table__cell--truncate" data-tooltip="{{ history.knowledgeKeys ? history.knowledgeKeys|join(', ')|e('html_attr') : '' }}">
                                    {% if history.knowledgeKeys %}
                                        {{ history.knowledgeKeys|join(', ') }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="admin-table__cell admin-table__cell--truncate" data-tooltip="{{ history.knowledgeKeysValidated ? history.knowledgeKeysValidated|join(', ')|e('html_attr') : '' }}">
                                    {% if history.knowledgeKeysValidated %}
                                        {{ history.knowledgeKeysValidated|join(', ') }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                {% set constraintsJson = history.constraints ? history.constraints|json_encode(constant('JSON_UNESCAPED_UNICODE')) : '' %}
                                <td class="admin-table__cell admin-table__cell--truncate admin-table__cell--mono" data-tooltip="{{ constraintsJson|e('html_attr') }}">
                                    {{ constraintsJson != '' ? constraintsJson|slice(0, 120) : '-' }}
                                </td>
                                <td class="admin-table__cell admin-table__cell--actions">
                                    <a class="admin-button admin-button--ghost"
                                       href="{{ path('admin_ai_history_show', {id: history.id}) }}"
                                       data-ai-history-view
                                       data-history-url="{{ path('admin_ai_history_json', {id: history.id}) }}">
                                        Voir
                                    </a>
                                </td>
                            </tr>
                        {% else %}
                            <tr class="admin-table__row">
                                <td class="admin-table__cell" colspan="12">Aucun historique.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="admin-pagination">
                <div class="admin-pagination__pages">
                    {% set prevPage = page > 1 ? page - 1 : 1 %}
                    {% set nextPage = page < pages ? page + 1 : pages %}
                    <a class="admin-pagination__link {{ page == 1 ? 'is-disabled' : '' }}"
                       href="{{ path('admin_ai_history', filters|merge({page: prevPage, limit: limit})) }}">Prev</a>
                    {% for p in 1..pages %}
                        <a class="admin-pagination__link {{ p == page ? 'is-active' : '' }}"
                           href="{{ path('admin_ai_history', filters|merge({page: p, limit: limit})) }}">{{ p }}</a>
                    {% endfor %}
                    <a class="admin-pagination__link {{ page == pages ? 'is-disabled' : '' }}"
                       href="{{ path('admin_ai_history', filters|merge({page: nextPage, limit: limit})) }}">Next</a>
                </div>
                <div class="admin-pagination__meta">
                    Page {{ page }} / {{ pages }} · {{ total }} entree(s)
                </div>
            </div>
        </div>
    </section>

    <div class="admin-modal" data-ai-history-modal aria-hidden="true">
        <div class="admin-modal__backdrop" data-modal-close></div>
        <div class="admin-modal__dialog admin-modal__dialog--wide" role="dialog" aria-modal="true">
            <div class="admin-modal__header">Historique AI</div>
            <div class="admin-modal__body">
                <div class="admin-grid admin-grid--two">
                    <div class="admin-table-wrap">
                        <table class="admin-table">
                            <tbody>
                                <tr class="admin-table__row">
                                    <th class="admin-table__cell">Date</th>
                                    <td class="admin-table__cell" data-history-field="created_at">-</td>
                                </tr>
                                <tr class="admin-table__row">
                                    <th class="admin-table__cell">Succes</th>
                                    <td class="admin-table__cell" data-history-field="success">-</td>
                                </tr>
                                <tr class="admin-table__row">
                                    <th class="admin-table__cell">Provider</th>
                                    <td class="admin-table__cell" data-history-field="provider">-</td>
                                </tr>
                                <tr class="admin-table__row">
                                    <th class="admin-table__cell">Model</th>
                                    <td class="admin-table__cell" data-history-field="model_name">-</td>
                                </tr>
                                <tr class="admin-table__row">
                                    <th class="admin-table__cell">Prompt slug</th>
                                    <td class="admin-table__cell" data-history-field="prompt_slug">-</td>
                                </tr>
                                <tr class="admin-table__row">
                                    <th class="admin-table__cell">Prompt version</th>
                                    <td class="admin-table__cell" data-history-field="prompt_version">-</td>
                                </tr>
                                <tr class="admin-table__row">
                                    <th class="admin-table__cell">Intent</th>
                                    <td class="admin-table__cell" data-history-field="intent">-</td>
                                </tr>
                                <tr class="admin-table__row">
                                    <th class="admin-table__cell">Intent raw</th>
                                    <td class="admin-table__cell" data-history-field="intent_raw">-</td>
                                </tr>
                                <tr class="admin-table__row">
                                    <th class="admin-table__cell">Latence (ms)</th>
                                    <td class="admin-table__cell" data-history-field="latency_ms">-</td>
                                </tr>
                                <tr class="admin-table__row">
                                    <th class="admin-table__cell">Tokens</th>
                                    <td class="admin-table__cell" data-history-field="tokens">-</td>
                                </tr>
                                <tr class="admin-table__row">
                                    <th class="admin-table__cell">Erreur</th>
                                    <td class="admin-table__cell" data-history-field="error_code">-</td>
                                </tr>
                                <tr class="admin-table__row">
                                    <th class="admin-table__cell">Knowledge keys</th>
                                    <td class="admin-table__cell" data-history-field="knowledge_keys">-</td>
                                </tr>
                                <tr class="admin-table__row">
                                    <th class="admin-table__cell">Keys validees</th>
                                    <td class="admin-table__cell" data-history-field="knowledge_keys_validated">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="admin-ai-console__logs">
                        <div class="admin-ai-console__log-block">
                            <div class="admin-ai-console__log-title">Prompt client</div>
                            <pre class="admin-console" data-history-field="prompt_client">-</pre>
                        </div>
                        <div class="admin-ai-console__log-block">
                            <div class="admin-ai-console__log-title">Final prompt</div>
                            <pre class="admin-console" data-history-field="final_prompt">-</pre>
                        </div>
                        <div class="admin-ai-console__log-block">
                            <div class="admin-ai-console__log-title">Reponse</div>
                            <pre class="admin-console" data-history-field="response">-</pre>
                        </div>
                    </div>
                </div>
                <div class="admin-grid admin-grid--two" style="margin-top: 18px;">
                    <div class="admin-ai-console__logs">
                        <div class="admin-ai-console__log-block">
                            <div class="admin-ai-console__log-title">Received</div>
                            <pre class="admin-console" data-history-field="received_json">{}</pre>
                        </div>
                        <div class="admin-ai-console__log-block">
                            <div class="admin-ai-console__log-title">Intent JSON</div>
                            <pre class="admin-console" data-history-field="intent_json">{}</pre>
                        </div>
                        <div class="admin-ai-console__log-block">
                            <div class="admin-ai-console__log-title">Pipeline JSON</div>
                            <pre class="admin-console" data-history-field="pipeline_json">{}</pre>
                        </div>
                        <div class="admin-ai-console__log-block">
                            <div class="admin-ai-console__log-title">Request payload</div>
                            <pre class="admin-console" data-history-field="request_payload_json">{}</pre>
                        </div>
                    </div>
                    <div class="admin-ai-console__logs">
                        <div class="admin-ai-console__log-block">
                            <div class="admin-ai-console__log-title">Response payload</div>
                            <pre class="admin-console" data-history-field="response_payload_json">{}</pre>
                        </div>
                        <div class="admin-ai-console__log-block">
                            <div class="admin-ai-console__log-title">Final prompt texte</div>
                            <pre class="admin-console" data-history-field="final_prompt_text">-</pre>
                        </div>
                    </div>
                </div>
            </div>
            <div class="admin-modal__actions">
                <button class="admin-button admin-button--ghost" type="button" data-modal-close>Fermer</button>
            </div>
        </div>
    </div>

    <script>
        (function () {
            var tooltip = document.createElement('div');
            tooltip.className = 'admin-tooltip is-hidden';
            document.body.appendChild(tooltip);

            function showTooltip(text, event) {
                if (!text) {
                    return;
                }
                tooltip.textContent = text;
                tooltip.style.left = (event.clientX + 12) + 'px';
                tooltip.style.top = (event.clientY + 12) + 'px';
                tooltip.classList.remove('is-hidden');
            }

            function hideTooltip() {
                tooltip.classList.add('is-hidden');
            }

            document.querySelectorAll('[data-tooltip]').forEach(function (element) {
                element.addEventListener('mouseenter', function (event) {
                    var text = element.getAttribute('data-tooltip') || '';
                    if (text.trim() !== '') {
                        showTooltip(text, event);
                    }
                });
                element.addEventListener('mousemove', function (event) {
                    var text = element.getAttribute('data-tooltip') || '';
                    if (text.trim() !== '') {
                        showTooltip(text, event);
                    }
                });
                element.addEventListener('mouseleave', hideTooltip);
            });

            var modal = document.querySelector('[data-ai-history-modal]');
            if (!modal) {
                return;
            }
            var modalFields = modal.querySelectorAll('[data-history-field]');
            var jsonFields = new Set([
                'received_json',
                'intent_json',
                'pipeline_json',
                'request_payload_json',
                'response_payload_json'
            ]);

            function setField(field, value) {
                var target = modal.querySelector('[data-history-field="' + field + '"]');
                if (!target) {
                    return;
                }
                var text = value;
                if (value === null || value === undefined || value === '') {
                    text = jsonFields.has(field) ? '{}' : '-';
                } else if (jsonFields.has(field)) {
                    text = JSON.stringify(value, null, 2);
                } else if (Array.isArray(value)) {
                    text = value.join(', ');
                } else if (typeof value === 'object') {
                    text = JSON.stringify(value, null, 2);
                }
                target.textContent = text;
            }

            function openModal() {
                modal.setAttribute('aria-hidden', 'false');
                modal.classList.add('is-open');
            }

            function closeModal() {
                modal.setAttribute('aria-hidden', 'true');
                modal.classList.remove('is-open');
            }

            modal.addEventListener('click', function (event) {
                if (event.target.closest('[data-modal-close]')) {
                    closeModal();
                }
            });

            document.querySelectorAll('[data-ai-history-view]').forEach(function (link) {
                link.addEventListener('click', function (event) {
                    var url = link.getAttribute('data-history-url');
                    if (!url) {
                        return;
                    }
                    event.preventDefault();
                    modalFields.forEach(function (field) {
                        field.textContent = field.tagName === 'PRE' ? '{}' : '-';
                    });
                    fetch(url, { headers: { 'Accept': 'application/json' } })
                        .then(function (response) { return response.json(); })
                        .then(function (payload) {
                            var history = payload.history || {};
                            var log = payload.log || {};
                            setField('created_at', history.created_at);
                            setField('success', history.success ? 'oui' : 'non');
                            setField('provider', history.provider);
                            setField('model_name', history.model_name);
                            setField('prompt_slug', history.prompt_slug);
                            setField('prompt_version', history.prompt_version);
                            setField('intent', history.intent);
                            setField('intent_raw', history.intent_raw);
                            setField('latency_ms', history.latency_ms);
                            setField('tokens', [
                                history.prompt_tokens,
                                history.completion_tokens,
                                history.total_tokens
                            ].filter(function (value) { return value !== null && value !== undefined; }).join(' / '));
                            setField('error_code', history.error_code);
                            setField('knowledge_keys', history.knowledge_keys);
                            setField('knowledge_keys_validated', history.knowledge_keys_validated);
                            setField('prompt_client', history.prompt_client);
                            setField('final_prompt', history.final_prompt);
                            setField('response', history.response);
                            setField('received_json', log.received_json);
                            setField('intent_json', log.intent_json);
                            setField('pipeline_json', log.pipeline_json);
                            setField('request_payload_json', log.request_payload_json);
                            setField('response_payload_json', log.response_payload_json);
                            setField('final_prompt_text', log.final_prompt_text);
                            openModal();
                        })
                        .catch(function () {
                            setField('response', 'Erreur lors du chargement du detail.');
                            openModal();
                        });
                });
            });
        })();
    </script>
{% endblock %}
