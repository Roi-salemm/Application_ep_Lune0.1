{# Page admin: import_horizon (telechargement + historique). #}
{# Pourquoi: declencher les imports bruts Moon/Sun et suivre les runs. #}
{# Infos: ce volet ne parse pas, il stocke uniquement raw_response. #}
{% extends 'admin/base.html.twig' %}

{% set page_title = 'Horizon data' %}
{% set page_subtitle = 'Telecharger et parser des donnees astronomiques.' %}
{% set active_menu = 'horizon' %}

{% block admin_content %}
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="admin-flash admin-flash--{{ label }}">{{ message }}</div>
        {% endfor %}
    {% endfor %}

    <div class="admin-grid">
        <section class="admin-card">
            <div class="admin-card__header">
                <h2 class="admin-card__title">Import mensuel (Moon + Sun)</h2>
                <p class="admin-card__subtitle">Telecharge raw_response Moon (1,2,10,20,31,43) + Sun (31) sur un mois complet.</p>
            </div>
            <div class="admin-month-import" data-month-initial="{{ next_month_start }}">
                <div class="admin-month-import__label">Prochain mois:</div>
                <div class="admin-month-import__value" data-month-label>{{ next_month_label }}</div>
                <div class="admin-month-import__field">
                    <label class="admin-form__label" for="bulk_step">Step</label>
                    <input class="admin-form__input" id="bulk_step" name="step" type="text" value="10m" list="step-options" form="month-import-form">
                    <datalist id="step-options">
                        <option value="5m"></option>
                        <option value="10m"></option>
                        <option value="15m"></option>
                        <option value="30m"></option>
                        <option value="1h"></option>
                        <option value="2h"></option>
                        <option value="1d"></option>
                    </datalist>
                </div>
            </div>
            <form class="admin-month-actions" id="month-import-form" method="post" action="{{ path('admin_horizon_data_bulk_month') }}">
                <input type="hidden" name="start" value="{{ next_month_start }}" data-month-input>
                <button class="admin-button admin-button--ghost" type="button" data-month-prev aria-label="Mois precedent">&lt;</button>
                <button class="admin-button admin-button--primary" type="submit">Ajouter ce mois</button>
                <button class="admin-button admin-button--ghost" type="button" data-month-next aria-label="Mois suivant">&gt;</button>
            </form>
        </section>
    </div>

    <section class="admin-card admin-card--table admin-import-calendar">
        <div class="admin-card__header">
            <h2 class="admin-card__title">Calendrier des imports Horizons</h2>
            <p class="admin-card__subtitle">Statut Moon + Sun par mois (complet, partiel, absent) avec import mensuel ou annuel.</p>
        </div>
        <div class="admin-import-calendar__legend">
            <span class="admin-import-calendar__legend-item admin-import-calendar__legend-item--complete">Complet</span>
            <span class="admin-import-calendar__legend-item admin-import-calendar__legend-item--partial">Partiel</span>
            <span class="admin-import-calendar__legend-item admin-import-calendar__legend-item--missing">Absent</span>
        </div>
        <div class="admin-table-wrap admin-import-calendar__table-wrap">
            <table class="admin-table admin-import-calendar__table">
                {% set month_labels = ['Janvier', 'Fevrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Aout', 'Septembre', 'Octobre', 'Novembre', 'Decembre'] %}
                <thead>
                    <tr>
                        <th class="admin-table__cell">Action</th>
                        <th class="admin-table__cell">Annee</th>
                        {% for label in month_labels %}
                            <th class="admin-table__cell admin-import-calendar__month-header">{{ label }}</th>
                        {% endfor %}
                        <th class="admin-table__cell">Sup</th>
                    </tr>
                </thead>
                <tbody>
                    {% for year in calendar_years %}
                        {% set year_status = year_coverage[year]|default('missing') %}
                        <tr class="admin-table__row">
                            <td class="admin-table__cell">
                                <button class="admin-button admin-import-calendar__year-button admin-import-calendar__year-button--{{ year_status }}" type="button" data-calendar-year-button data-calendar-year="{{ year }}">Annee</button>
                            </td>
                            <td class="admin-table__cell admin-import-calendar__year-label">{{ year }}</td>
                            {% for month in 1..12 %}
                                {% set month_key = year ~ '-' ~ '%02d'|format(month) %}
                                {% set month_status = month_coverage[month_key]|default('missing') %}
                                <td class="admin-table__cell admin-import-calendar__cell" title="{{ month_key }}">
                                    <button
                                        class="admin-import-calendar__month-button admin-import-calendar__month-button--{{ month_status }}"
                                        type="button"
                                        data-calendar-month-button
                                        data-calendar-month="{{ month_key }}-01"
                                        data-calendar-month-status="{{ month_status }}"
                                        data-calendar-month-label="{{ month_labels[month - 1] }} {{ year }}"
                                    >{{ month_labels[month - 1] }}</button>
                                </td>
                            {% endfor %}
                            <td class="admin-table__cell admin-import-calendar__cell">
                                <button
                                    class="admin-button admin-button--danger admin-import-calendar__delete-button"
                                    type="button"
                                    data-delete-year-button
                                    data-delete-year="{{ year }}"
                                    data-delete-year-token="{{ csrf_token('delete_import_year_' ~ year) }}"
                                    onclick="window.openDeleteYearModal && window.openDeleteYearModal('{{ year }}', '{{ csrf_token('delete_import_year_' ~ year) }}')"
                                >Sup</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <form class="admin-import-calendar__form" method="post" action="{{ path('admin_horizon_data_bulk_month') }}" data-calendar-month-form>
            <input type="hidden" name="start" value="" data-calendar-month-input>
            <input type="hidden" name="step" value="10m">
            <input type="hidden" name="force" value="0" data-calendar-month-force>
        </form>
        <form class="admin-import-calendar__form" method="post" action="{{ path('admin_horizon_data_bulk_year') }}" data-calendar-year-form>
            <input type="hidden" name="year" value="" data-calendar-year-input>
            <input type="hidden" name="step" value="10m">
        </form>
    </section>

    <section class="admin-card admin-card--table">
        <div class="admin-card__header">
            <h2 class="admin-card__title">Historique des imports</h2>
            <p class="admin-card__subtitle">Derniers runs en base.</p>
        </div>
        {% if imports is empty %}
            <p class="admin-empty">Aucun import pour le moment.</p>
        {% else %}
            {% set id_dir = sort == 'id' and dir == 'asc' ? 'desc' : 'asc' %}
            {% set period_dir = sort == 'period' and dir == 'asc' ? 'desc' : 'asc' %}
            <div class="admin-table-wrap">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th class="admin-table__cell">
                                <a class="admin-table__sort {{ sort == 'id' ? 'is-active' : '' }}"
                                   href="{{ path('admin_horizon_data', {'page': 1, 'sort': 'id', 'dir': id_dir}) }}">ID</a>
                            </th>
                            <th class="admin-table__cell">Provider</th>
                            <th class="admin-table__cell">Target</th>
                            <th class="admin-table__cell">Center</th>
                            <th class="admin-table__cell">Year</th>
                            <th class="admin-table__cell">
                                <a class="admin-table__sort {{ sort == 'period' ? 'is-active' : '' }}"
                                   href="{{ path('admin_horizon_data', {'page': 1, 'sort': 'period', 'dir': period_dir}) }}">Start UTC</a>
                            </th>
                            <th class="admin-table__cell">Stop UTC</th>
                            <th class="admin-table__cell">Step</th>
                            <th class="admin-table__cell">Time zone</th>
                            <th class="admin-table__cell">SHA256</th>
                            <th class="admin-table__cell">Retrieved</th>
                            <th class="admin-table__cell">Status</th>
                            <th class="admin-table__cell">Error</th>
                            <th class="admin-table__cell">Raw size</th>
                            <th class="admin-table__cell admin-table__cell--actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for import in imports %}
                            <tr class="admin-table__row" data-run-id="{{ import.id }}">
                                <td class="admin-table__cell">{{ import.id }}</td>
                                <td class="admin-table__cell">{{ import.provider }}</td>
                                <td class="admin-table__cell">{{ import.target }}</td>
                                <td class="admin-table__cell">{{ import.center }}</td>
                                <td class="admin-table__cell">{{ import.year }}</td>
                                <td class="admin-table__cell">{{ import.startUtc ? import.startUtc|date('Y-m-d H:i') : '' }}</td>
                                <td class="admin-table__cell">{{ import.stopUtc ? import.stopUtc|date('Y-m-d H:i') : '' }}</td>
                                <td class="admin-table__cell">{{ import.stepSize }}</td>
                                <td class="admin-table__cell">{{ import.timeZone }}</td>
                                <td class="admin-table__cell admin-table__cell--mono admin-table__cell--truncate">{{ import.sha256 }}</td>
                                <td class="admin-table__cell">{{ import.retrievedAtUtc ? import.retrievedAtUtc|date('Y-m-d H:i') : '' }}</td>
                                <td class="admin-table__cell">
                                    <span class="admin-status admin-status--{{ import.status ?: 'unknown' }}">
                                        {{ import.status ?: 'unknown' }}
                                    </span>
                                </td>
                                <td class="admin-table__cell admin-table__cell--truncate">{{ import.errorMessage }}</td>
                                <td class="admin-table__cell">{{ import.rawResponse ? import.rawResponse|length : 0 }}</td>
                                <td class="admin-table__cell admin-table__cell--actions">
                                    <button
                                        class="admin-button admin-button--danger"
                                        type="button"
                                        data-delete-button
                                        data-delete-id="{{ import.id }}"
                                        data-delete-token="{{ csrf_token('delete_import_' ~ import.id) }}"
                                        data-delete-action="{{ path('admin_horizon_data_delete', {id: import.id}) }}"
                                    >Supprimer</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if total_pages > 1 %}
                <div class="admin-pagination">
                    <a class="admin-pagination__link {{ page <= 1 ? 'is-disabled' : '' }}"
                       href="{{ path('admin_horizon_data', {'page': page - 1, 'sort': sort, 'dir': dir}) }}">Precedent</a>
                    <div class="admin-pagination__pages">
                        {% set start_page = page - 2 %}
                        {% set end_page = page + 2 %}
                        {% if start_page < 1 %}{% set start_page = 1 %}{% endif %}
                        {% if end_page > total_pages %}{% set end_page = total_pages %}{% endif %}
                        {% for p in start_page..end_page %}
                            <a class="admin-pagination__link {{ p == page ? 'is-active' : '' }}"
                               href="{{ path('admin_horizon_data', {'page': p, 'sort': sort, 'dir': dir}) }}">{{ p }}</a>
                        {% endfor %}
                    </div>
                    <a class="admin-pagination__link {{ page >= total_pages ? 'is-disabled' : '' }}"
                       href="{{ path('admin_horizon_data', {'page': page + 1, 'sort': sort, 'dir': dir}) }}">Suivant</a>
                    <span class="admin-pagination__meta">{{ total_count }} lignes</span>
                </div>
            {% endif %}
        {% endif %}
    </section>

    <section class="admin-card">
        <div class="admin-card__header">
            <h2 class="admin-card__title">Suppression globale</h2>
            <p class="admin-card__subtitle">Supprime tous les runs + ephemerides Moon.</p>
        </div>
        <button
            class="admin-button admin-button--danger"
            type="button"
            data-delete-all-button
            data-delete-all-token="{{ csrf_token('delete_all_imports') }}"
            data-delete-all-action="{{ path('admin_horizon_data_delete_all') }}"
        >Tout supprimer</button>
    </section>

    <div class="admin-modal" data-delete-modal aria-hidden="true">
        <div class="admin-modal__backdrop" data-modal-close></div>
        <div class="admin-modal__dialog" role="dialog" aria-modal="true">
            <div class="admin-modal__header">Confirmer la suppression</div>
            <div class="admin-modal__body">
                Voulez-vous supprimer ce run ? Les lignes associees seront supprimees.
            </div>
            <form class="admin-modal__actions" method="post" data-modal-form>
                <input type="hidden" name="_token" value="" data-modal-token>
                <button class="admin-button admin-button--danger" type="submit">Supprimer</button>
                <button class="admin-button" type="button" data-modal-close>Annuler</button>
            </form>
        </div>
    </div>

    <div class="admin-modal" data-delete-all-modal aria-hidden="true">
        <div class="admin-modal__backdrop" data-modal-close></div>
        <div class="admin-modal__dialog" role="dialog" aria-modal="true">
            <div class="admin-modal__header">Tout supprimer</div>
            <div class="admin-modal__body">
                Cette action supprime toutes les donnees Moon et les runs d'import.
                Confirmer ?
            </div>
            <form class="admin-modal__actions" method="post" data-delete-all-form>
                <input type="hidden" name="_token" value="" data-delete-all-token-input>
                <button class="admin-button admin-button--danger" type="submit">Supprimer tout</button>
                <button class="admin-button" type="button" data-modal-close>Annuler</button>
            </form>
        </div>
    </div>

    <div class="admin-modal" data-month-reimport-modal aria-hidden="true">
        <div class="admin-modal__backdrop" data-modal-close></div>
        <div class="admin-modal__dialog" role="dialog" aria-modal="true">
            <div class="admin-modal__header">Mois deja complet</div>
            <div class="admin-modal__body" data-month-reimport-label>
                Ce mois est deja complet. Relancer le telechargement Horizons ?
            </div>
            <div class="admin-modal__actions">
                <button class="admin-button admin-button--primary" type="button" data-month-reimport-confirm>Telecharger</button>
                <button class="admin-button" type="button" data-modal-close>Annuler</button>
            </div>
        </div>
    </div>

    <div class="admin-modal" data-delete-year-modal aria-hidden="true">
        <div class="admin-modal__backdrop" data-modal-close></div>
        <div class="admin-modal__dialog" role="dialog" aria-modal="true">
            <div class="admin-modal__header">Supprimer une annee</div>
            <div class="admin-modal__body" data-delete-year-label>
                Supprimer tous les runs import_horizon pour cette annee ?
            </div>
            <form class="admin-modal__actions" method="post" action="{{ path('admin_horizon_data_delete_year') }}" data-delete-year-form>
                <input type="hidden" name="year" value="" data-delete-year-input>
                <input type="hidden" name="_token" value="" data-delete-year-token-input>
                <button class="admin-button admin-button--danger" type="submit">Supprimer</button>
                <button class="admin-button" type="button" data-modal-close>Annuler</button>
            </form>
        </div>
    </div>

    <script>
        (function () {
            var container = document.querySelector('.admin-month-import');
            var input = document.querySelector('[data-month-input]');
            var label = document.querySelector('[data-month-label]');
            var prev = document.querySelector('[data-month-prev]');
            var next = document.querySelector('[data-month-next]');
            if (!container || !input || !label || !prev || !next) {
                return;
            }

            var monthNames = ['Janvier', 'Fevrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Aout', 'Septembre', 'Octobre', 'Novembre', 'Decembre'];

            function formatLabel(date) {
                var year = date.getUTCFullYear();
                var month = date.getUTCMonth() + 1;
                var padded = month < 10 ? '0' + month : String(month);
                return year + ' ' + padded + ' (' + monthNames[month - 1] + ')';
            }

            function readDate() {
                var value = input.value || container.getAttribute('data-month-initial');
                var parts = value.split('-');
                if (parts.length < 2) {
                    return new Date();
                }
                var year = parseInt(parts[0], 10);
                var month = parseInt(parts[1], 10) - 1;
                return new Date(Date.UTC(year, month, 1));
            }

            function writeDate(date) {
                var year = date.getUTCFullYear();
                var month = date.getUTCMonth() + 1;
                var padded = month < 10 ? '0' + month : String(month);
                input.value = year + '-' + padded + '-01';
                label.textContent = formatLabel(date);
            }

            prev.addEventListener('click', function () {
                var date = readDate();
                date.setUTCMonth(date.getUTCMonth() - 1);
                writeDate(date);
            });

            next.addEventListener('click', function () {
                var date = readDate();
                date.setUTCMonth(date.getUTCMonth() + 1);
                writeDate(date);
            });

            writeDate(readDate());
        })();
    </script>
    <script>
        (function () {
            var monthForm = document.querySelector('[data-calendar-month-form]');
            var monthInput = document.querySelector('[data-calendar-month-input]');
            var monthForce = document.querySelector('[data-calendar-month-force]');
            var monthButtons = document.querySelectorAll('[data-calendar-month-button]');
            var yearForm = document.querySelector('[data-calendar-year-form]');
            var yearInput = document.querySelector('[data-calendar-year-input]');
            var yearButtons = document.querySelectorAll('[data-calendar-year-button]');
            var monthModal = document.querySelector('[data-month-reimport-modal]');
            var monthModalLabel = document.querySelector('[data-month-reimport-label]');
            var monthModalConfirm = document.querySelector('[data-month-reimport-confirm]');
            var pendingMonthValue = null;
            if (!monthForm || !monthInput || !yearForm || !yearInput) {
                return;
            }

            monthButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    var value = button.getAttribute('data-calendar-month');
                    var status = button.getAttribute('data-calendar-month-status');
                    var labelValue = button.getAttribute('data-calendar-month-label') || value || '';
                    if (!value) {
                        return;
                    }
                    if (status === 'complete' && monthModal && monthModalConfirm) {
                        pendingMonthValue = value;
                        if (monthModalLabel) {
                            monthModalLabel.textContent = 'Ce mois est deja complet (' + labelValue + '). Relancer le telechargement Horizons ?';
                        }
                        monthModal.setAttribute('aria-hidden', 'false');
                        monthModal.classList.add('is-open');
                        return;
                    }
                    if (monthForce) {
                        monthForce.value = '0';
                    }
                    monthInput.value = value;
                    monthForm.submit();
                });
            });

            function closeMonthModal() {
                if (!monthModal) {
                    return;
                }
                monthModal.setAttribute('aria-hidden', 'true');
                monthModal.classList.remove('is-open');
                if (monthForce) {
                    monthForce.value = '0';
                }
                pendingMonthValue = null;
            }

            if (monthModalConfirm) {
                monthModalConfirm.addEventListener('click', function () {
                    if (!pendingMonthValue) {
                        return;
                    }
                    if (monthForce) {
                        monthForce.value = '1';
                    }
                    monthInput.value = pendingMonthValue;
                    monthForm.submit();
                });
            }

            if (monthModal) {
                monthModal.addEventListener('click', function (event) {
                    if (event.target.closest('[data-modal-close]')) {
                        closeMonthModal();
                    }
                });
            }

            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape') {
                    closeMonthModal();
                }
            });

            yearButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    var value = button.getAttribute('data-calendar-year');
                    if (!value) {
                        return;
                    }
                    yearInput.value = value;
                    yearForm.submit();
                });
            });
        })();
    </script>
    <script>
        (function () {
            var modal = document.querySelector('[data-delete-modal]');
            var form = document.querySelector('[data-modal-form]');
            var tokenInput = document.querySelector('[data-modal-token]');
            var buttons = document.querySelectorAll('[data-delete-button]');
            if (!modal || !form || !tokenInput || !buttons.length) {
                return;
            }

            function closeModal() {
                modal.setAttribute('aria-hidden', 'true');
                modal.classList.remove('is-open');
            }

            buttons.forEach(function (button) {
                button.addEventListener('click', function () {
                    var action = button.getAttribute('data-delete-action');
                    var token = button.getAttribute('data-delete-token');
                    if (!action || !token) {
                        return;
                    }
                    form.setAttribute('action', action);
                    tokenInput.value = token;
                    modal.setAttribute('aria-hidden', 'false');
                    modal.classList.add('is-open');
                });
            });

            modal.addEventListener('click', function (event) {
                if (event.target.closest('[data-modal-close]')) {
                    closeModal();
                }
            });

            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape') {
                    closeModal();
                }
            });
        })();
    </script>
    <script>
        (function () {
            var modal = document.querySelector('[data-delete-all-modal]');
            var form = document.querySelector('[data-delete-all-form]');
            var tokenInput = modal ? modal.querySelector('[data-delete-all-token-input]') : null;
            var button = document.querySelector('[data-delete-all-button]');
            if (!modal || !form || !tokenInput || !button) {
                return;
            }

            function closeModal() {
                modal.setAttribute('aria-hidden', 'true');
                modal.classList.remove('is-open');
            }

            button.addEventListener('click', function () {
                var action = button.getAttribute('data-delete-all-action');
                var token = button.getAttribute('data-delete-all-token');
                if (!action || !token) {
                    return;
                }
                form.setAttribute('action', action);
                tokenInput.value = token;
                modal.setAttribute('aria-hidden', 'false');
                modal.classList.add('is-open');
            });

            modal.addEventListener('click', function (event) {
                if (event.target.closest('[data-modal-close]')) {
                    closeModal();
                }
            });

            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape') {
                    closeModal();
                }
            });
        })();
    </script>
    <script>
        (function () {
            var modal = document.querySelector('[data-delete-year-modal]');
            var form = document.querySelector('[data-delete-year-form]');
            var input = document.querySelector('[data-delete-year-input]');
            var tokenInput = document.querySelector('[data-delete-year-token-input]');
            var label = document.querySelector('[data-delete-year-label]');
            if (!modal || !form || !input || !tokenInput) {
                return;
            }

            function closeModal() {
                modal.setAttribute('aria-hidden', 'true');
                modal.classList.remove('is-open');
            }

            window.openDeleteYearModal = function (year, token) {
                if (!year) {
                    return;
                }
                input.value = year;
                tokenInput.value = token || '';
                if (label) {
                    label.textContent = 'Supprimer tous les runs import_horizon pour l\'annee ' + year + ' ?';
                }
                modal.setAttribute('aria-hidden', 'false');
                modal.classList.add('is-open');
            };

            document.addEventListener('click', function (event) {
                var button = event.target.closest('[data-delete-year-button]');
                if (!button) {
                    return;
                }
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                var year = button.getAttribute('data-delete-year');
                var token = button.getAttribute('data-delete-year-token');
                window.openDeleteYearModal(year, token);
            });

            modal.addEventListener('click', function (event) {
                if (event.target.closest('[data-modal-close]')) {
                    closeModal();
                }
            });

            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape') {
                    closeModal();
                }
            });
        })();
    </script>
    <script>
        (function () {
            var storageKey = 'admin_horizon_scroll_y';

            function saveScroll() {
                if (typeof sessionStorage === 'undefined') {
                    return;
                }
                sessionStorage.setItem(storageKey, String(window.scrollY || 0));
            }

            function restoreScroll() {
                if (typeof sessionStorage === 'undefined') {
                    return;
                }
                var value = sessionStorage.getItem(storageKey);
                if (!value) {
                    return;
                }
                var y = parseInt(value, 10);
                if (Number.isNaN(y)) {
                    return;
                }
                window.scrollTo(0, y);
            }

            window.addEventListener('beforeunload', saveScroll);
            window.addEventListener('load', function () {
                setTimeout(restoreScroll, 0);
            });
        })();
    </script>
    <script>
        (function () {
            // Script de debug retire: activation normale du modal Sup.
        })();
    </script>
{% endblock %}
