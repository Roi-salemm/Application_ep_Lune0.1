{# Page admin: affiche la table canonique_data et permet le parse mensuel. #}
{# Pourquoi: offrir une vue brute des donnees Horizons (Moon + Sun). #}
{# Infos: les colonnes sont dynamiques, d'ou un rendu table large. #}
{% extends 'admin/base.html.twig' %}

{% set page_title = 'Canonique data' %}
{% set page_subtitle = 'Donnees brutes Horizons (page ' ~ page ~ '/' ~ total_pages ~ ', limite: ' ~ limit ~ ').' %}
{% set active_menu = 'canonique' %}

{% block admin_content %}
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="admin-flash admin-flash--{{ label }}">{{ message }}</div>
        {% endfor %}
    {% endfor %}

    <section class="admin-card admin-card--table admin-import-calendar">
        <div class="admin-card__header">
            <h2 class="admin-card__title">Calendrier de parsing canonique_data</h2>
            <p class="admin-card__subtitle">Gris: non parse. Bleu: imports disponibles. Dore: mois deja parse.</p>
        </div>
        <div class="admin-import-calendar__legend">
            <span class="admin-import-calendar__legend-item admin-import-calendar__legend-item--missing">Non parse</span>
            <span class="admin-import-calendar__legend-item admin-import-calendar__legend-item--ready">Pret a parser</span>
            <span class="admin-import-calendar__legend-item admin-import-calendar__legend-item--parsed">Parse</span>
        </div>
        <div class="admin-table-wrap admin-import-calendar__table-wrap">
            <table class="admin-table admin-import-calendar__table">
                {% set month_labels = ['Janvier', 'Fevrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Aout', 'Septembre', 'Octobre', 'Novembre', 'Decembre'] %}
                <thead>
                    <tr>
                        <th class="admin-table__cell">Parse</th>
                        <th class="admin-table__cell">Annee</th>
                        {% for label in month_labels %}
                            <th class="admin-table__cell admin-import-calendar__month-header">{{ label }}</th>
                        {% endfor %}
                        <th class="admin-table__cell">Sup</th>
                    </tr>
                </thead>
                <tbody>
                    {% for year in calendar_years %}
                        {% set year_status = year_coverage[year]|default('missing') %}
                        <tr class="admin-table__row">
                            <td class="admin-table__cell">
                                <button class="admin-button admin-import-calendar__year-button admin-import-calendar__year-button--{{ year_status }}" type="button" data-canonique-year-button data-canonique-year="{{ year }}">Parse</button>
                            </td>
                            <td class="admin-table__cell admin-import-calendar__year-label">{{ year }}</td>
                            {% for month in 1..12 %}
                                {% set month_key = year ~ '-' ~ '%02d'|format(month) %}
                                {% set month_status = month_coverage[month_key]|default('missing') %}
                                <td class="admin-table__cell admin-import-calendar__cell" title="{{ month_key }}">
                                    <button
                                        class="admin-import-calendar__month-button admin-import-calendar__month-button--{{ month_status }}"
                                        type="button"
                                        data-canonique-month-button
                                        data-canonique-month="{{ month_key }}-01"
                                        data-canonique-month-status="{{ month_status }}"
                                        data-canonique-month-label="{{ month_labels[month - 1] }} {{ year }}"
                                    >{{ month_labels[month - 1] }}</button>
                                </td>
                            {% endfor %}
                            <td class="admin-table__cell admin-import-calendar__cell">
                                <button
                                    class="admin-button admin-button--danger admin-import-calendar__delete-button"
                                    type="button"
                                    data-delete-canonique-year-button
                                    data-delete-canonique-year="{{ year }}"
                                    data-delete-canonique-year-token="{{ csrf_token('delete_canonique_year_' ~ year) }}"
                                    onclick="window.openDeleteCanoniqueYearModal && window.openDeleteCanoniqueYearModal('{{ year }}', '{{ csrf_token('delete_canonique_year_' ~ year) }}')"
                                >Sup</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <form class="admin-import-calendar__form" method="post" action="{{ path('admin_canonique_data_parse_month') }}" data-canonique-month-form>
            <input type="hidden" name="start" value="" data-canonique-month-input>
        </form>
        <form class="admin-import-calendar__form" method="post" action="{{ path('admin_canonique_data_parse_year') }}" data-canonique-year-form>
            <input type="hidden" name="year" value="" data-canonique-year-input>
        </form>
    </section>

    <section class="admin-card">
        <div class="admin-card__header">
            <h2 class="admin-card__title">Parser un mois</h2>
            <p class="admin-card__subtitle">Transforme les imports bruts en canonique_data.</p>
        </div>
        <div class="admin-month-import" data-month-initial="{{ next_month_start }}">
            <div class="admin-month-import__label">Prochain mois:</div>
            <div class="admin-month-import__value" data-month-label>{{ next_month_label }}</div>
        </div>
        <form class="admin-month-actions" id="canonique-parse-form" method="post" action="{{ path('admin_canonique_data_parse_month') }}">
            <input type="hidden" name="start" value="{{ next_month_start }}" data-month-input>
            <button class="admin-button admin-button--ghost" type="button" data-month-prev aria-label="Mois precedent">&lt;</button>
            <button class="admin-button admin-button--primary" type="submit">Parser ce mois</button>
            <button class="admin-button admin-button--ghost" type="button" data-month-next aria-label="Mois suivant">&gt;</button>
        </form>
    </section>

    <section class="admin-card admin-card--table">
        <div class="admin-card__header">
            <h2 class="admin-card__title">Table canonique_data</h2>
            <p class="admin-card__subtitle">Affichage des derniers enregistrements.</p>
        </div>

        {% if rows is empty %}
            <p class="admin-empty">Aucune donnee disponible.</p>
        {% else %}
            <div class="admin-table-wrap">
                <table class="admin-table">
                    <thead>
                        <tr>
                            {% for col in columns %}
                                <th class="admin-table__cell">{{ col }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in rows %}
                            <tr>
                                {% for col in columns %}
                                    {% set value = row[col] ?? '' %}
                                    <td class="admin-table__cell {{ col in ['m_raw_line', 's_raw_line'] ? 'admin-table__cell--mono admin-table__cell--truncate' : '' }}"
                                        title="{{ value }}">{{ value }}</td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if total_pages > 1 %}
                <div class="admin-pagination">
                    <a class="admin-pagination__link {{ page <= 1 ? 'is-disabled' : '' }}"
                       href="{{ path('admin_canonique_data', {'page': page - 1}) }}">&lt;</a>
                    <div class="admin-pagination__pages">
                        {% set head_max = total_pages < 5 ? total_pages : 5 %}
                        {% for p in 1..head_max %}
                            <a class="admin-pagination__link {{ p == page ? 'is-active' : '' }}"
                               href="{{ path('admin_canonique_data', {'page': p}) }}">{{ p }}</a>
                        {% endfor %}
                        {% if total_pages > head_max %}
                            <span class="admin-pagination__meta">...</span>
                            <a class="admin-pagination__link {{ page == total_pages ? 'is-active' : '' }}"
                               href="{{ path('admin_canonique_data', {'page': total_pages}) }}">{{ total_pages }}</a>
                        {% endif %}
                    </div>
                    <a class="admin-pagination__link {{ page >= total_pages ? 'is-disabled' : '' }}"
                       href="{{ path('admin_canonique_data', {'page': page + 1}) }}">&gt;</a>
                    <span class="admin-pagination__meta">{{ total_count }} lignes</span>
                </div>
            {% endif %}
        {% endif %}
    </section>

    <div class="admin-modal" data-delete-canonique-year-modal aria-hidden="true">
        <div class="admin-modal__backdrop" data-modal-close></div>
        <div class="admin-modal__dialog" role="dialog" aria-modal="true">
            <div class="admin-modal__header">Supprimer une annee</div>
            <div class="admin-modal__body" data-delete-canonique-year-label>
                Supprimer toutes les lignes canonique_data pour cette annee ?
            </div>
            <form class="admin-modal__actions" method="post" action="{{ path('admin_canonique_data_delete_year') }}" data-delete-canonique-year-form>
                <input type="hidden" name="year" value="" data-delete-canonique-year-input>
                <input type="hidden" name="_token" value="" data-delete-canonique-year-token-input>
                <button class="admin-button admin-button--danger" type="submit">Supprimer</button>
                <button class="admin-button" type="button" data-modal-close>Annuler</button>
            </form>
        </div>
    </div>

    <script>
        (function () {
            var container = document.querySelector('.admin-month-import');
            var input = document.querySelector('[data-month-input]');
            var label = document.querySelector('[data-month-label]');
            var prev = document.querySelector('[data-month-prev]');
            var next = document.querySelector('[data-month-next]');
            if (!container || !input || !label || !prev || !next) {
                return;
            }

            var monthNames = ['Janvier', 'Fevrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Aout', 'Septembre', 'Octobre', 'Novembre', 'Decembre'];

            function formatLabel(date) {
                var year = date.getUTCFullYear();
                var month = date.getUTCMonth() + 1;
                var padded = month < 10 ? '0' + month : String(month);
                return year + ' ' + padded + ' (' + monthNames[month - 1] + ')';
            }

            function readDate() {
                var value = input.value || container.getAttribute('data-month-initial');
                var parts = value.split('-');
                if (parts.length < 2) {
                    return new Date();
                }
                var year = parseInt(parts[0], 10);
                var month = parseInt(parts[1], 10) - 1;
                return new Date(Date.UTC(year, month, 1));
            }

            function writeDate(date) {
                var year = date.getUTCFullYear();
                var month = date.getUTCMonth() + 1;
                var padded = month < 10 ? '0' + month : String(month);
                input.value = year + '-' + padded + '-01';
                label.textContent = formatLabel(date);
            }

            prev.addEventListener('click', function () {
                var date = readDate();
                date.setUTCMonth(date.getUTCMonth() - 1);
                writeDate(date);
            });

            next.addEventListener('click', function () {
                var date = readDate();
                date.setUTCMonth(date.getUTCMonth() + 1);
                writeDate(date);
            });

            writeDate(readDate());
        })();
    </script>
    <script>
        (function () {
            var monthForm = document.querySelector('[data-canonique-month-form]');
            var monthInput = document.querySelector('[data-canonique-month-input]');
            var monthButtons = document.querySelectorAll('[data-canonique-month-button]');
            var yearForm = document.querySelector('[data-canonique-year-form]');
            var yearInput = document.querySelector('[data-canonique-year-input]');
            var yearButtons = document.querySelectorAll('[data-canonique-year-button]');
            if (!monthForm || !monthInput || !yearForm || !yearInput) {
                return;
            }

            monthButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    var value = button.getAttribute('data-canonique-month');
                    if (!value) {
                        return;
                    }
                    monthInput.value = value;
                    monthForm.submit();
                });
            });

            yearButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    var value = button.getAttribute('data-canonique-year');
                    if (!value) {
                        return;
                    }
                    yearInput.value = value;
                    yearForm.submit();
                });
            });
        })();
    </script>
    <script>
        (function () {
            var modal = document.querySelector('[data-delete-canonique-year-modal]');
            var form = document.querySelector('[data-delete-canonique-year-form]');
            var input = document.querySelector('[data-delete-canonique-year-input]');
            var tokenInput = document.querySelector('[data-delete-canonique-year-token-input]');
            var label = document.querySelector('[data-delete-canonique-year-label]');
            if (!modal || !form || !input || !tokenInput) {
                return;
            }

            function closeModal() {
                modal.setAttribute('aria-hidden', 'true');
                modal.classList.remove('is-open');
            }

            window.openDeleteCanoniqueYearModal = function (year, token) {
                if (!year) {
                    return;
                }
                input.value = year;
                tokenInput.value = token || '';
                if (label) {
                    label.textContent = 'Supprimer toutes les lignes canonique_data pour l\'annee ' + year + ' ?';
                }
                modal.setAttribute('aria-hidden', 'false');
                modal.classList.add('is-open');
            };

            document.addEventListener('click', function (event) {
                var button = event.target.closest('[data-delete-canonique-year-button]');
                if (!button) {
                    return;
                }
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                var year = button.getAttribute('data-delete-canonique-year');
                var token = button.getAttribute('data-delete-canonique-year-token');
                window.openDeleteCanoniqueYearModal(year, token);
            });

            modal.addEventListener('click', function (event) {
                if (event.target.closest('[data-modal-close]')) {
                    closeModal();
                }
            });

            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape') {
                    closeModal();
                }
            });
        })();
    </script>
{% endblock %}
