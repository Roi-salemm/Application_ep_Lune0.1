# Symfony AI — Spécification complète (v0) — Scope: symbolic_weather uniquement (sans code)

## 0) But du document
Ce document décrit **exactement** l’architecture, les dossiers, les responsabilités, le workflow et les contrats (JSON) pour implémenter v0 de l’IA locale dans Symfony.  
CODEX doit créer la structure et coder selon ce document.  
**Important** : v0 ne couvre que `symbolic_weather` + tradition unique `western_astrology`.  
Les autres contextes et traditions sont prévus par la structure mais non implémentés en v0.

---

## 1) Objectifs v0
- Intégrer un LLM local via **Ollama** (modèle: `llama3.1:8b`).
- Exposer un endpoint Symfony : `POST /api/ai/weather`.
- Générer une **météo symbolique** descriptive (impersonnelle), **sans injonction**, **sans syncrétisme**.
- Sortie **STRICTEMENT** en JSON, conforme à un **JSON Schema**.
- Symfony orchestre :
  1) construction du prompt,
  2) appel Ollama,
  3) parsing JSON,
  4) validation JSON Schema,
  5) guardrails (anti-injonction, anti-syncrétisme),
  6) logs/audit,
  7) réponse JSON à l’app.

### Contraintes éditoriales v0
- Texte descriptif, impersonnel, “météo symbolique” (style Yi Jing: décrit un climat, pas d’ordre, pas de conseil).
- Interdiction d’injonctions : pas de “tu dois”, “il faut”, impératif, “je te conseille”, etc.
- Interdiction de syncrétisme : si cadre `western_astrology`, pas d’emprunts à d’autres systèmes (chakras, karma, etc.).
- Si l’utilisateur utilise un vocabulaire mixte : la réponse **doit rester dans une tradition** et le signaler (champ `assumptions`).

### Décision v0 (important)
- **Pas de rewrite/regen automatique en v0**.  
  Si JSON invalide ou guardrails échouent → Symfony retourne une **erreur claire** (et log).  
  (Rewrite/regen sera ajouté en v1+.)

---

## 2) Choix technique : Option B (structured outputs)
- Ollama supporte les “structured outputs” via le champ `format`.
- En v0, Symfony envoie un **JSON Schema** dans `format` pour contraindre la réponse LLM.
- Symfony re-valide ensuite la réponse avec un validateur JSON Schema (Opis).

---

Notes :

message peut être vide dans v0 (on peut générer uniquement à partir du snapshot).

lunar_snapshot est nécessaire en v0.

Output (response body JSON)
Symfony renvoie le JSON produit par le modèle, après validation et guardrails.

4) Contrat JSON (réponse attendue v0.1)
### (request JSON)
```json
{
  "meta": {
    "schema_version": "1.0",
    "created_at_utc": "2026-02-19T00:00:00Z",
    "language": "fr",
    "request_id": "req_1234567890"
  },
  "routing": {
    "context": "symbolic_weather",
    "tradition": "western_astrology",
    "selection_mode": "auto",
    "confidence": 0.86,
    "user_intent": "explanation",
    "depth_mode": "standard",
    "format": "plain",
    "tone": "neutral"
  },
  "safety_and_limits": {
    "sensitivity": "low",
    "risk_flags": {
      "medical": false,
      "legal": false,
      "financial": false,
      "self_harm": false,
      "violence": false,
      "hate": false,
      "sexual_content": false,
      "minors": false
    },
    "policy_flags": {
      "prompt_injection": false,
      "proselitism_request": false,
      "diagnosis_request": false,
      "explicit_instruction_request": false
    },
    "action": {
      "mode": "allow",
      "reason": ""
    },
    "note": "Réponse symbolique descriptive. Aucun conseil, aucune injonction, aucun diagnostic, aucune prédiction factuelle."
  },
  "content": {
    "title": "Climat du moment",
    "text": "Climat de concentration et de tri. Le temps met en avant la cohérence, la structure et la continuité. La perception devient plus sensible aux écarts entre intention et réalité. L’atmosphère favorise les ajustements progressifs, sans urgence. Des frictions peuvent apparaître autour des limites et des responsabilités, comme un rappel de cadre plutôt qu’un obstacle.",
    "bullets": [],
    "sections": []
  },
  "data_used": {
    "lunar_snapshot": {
      "moon_phase": "waxing_gibbous",
      "moon_sign": "capricorn",
      "moon_degree": 13.76
    },
    "inputs_present": {
      "user_message": false,
      "history": false,
      "lunar_snapshot": true
    }
  },
  "glossary_and_definitions": [
    {
      "term": "Phase lunaire",
      "definition": "Indication astronomique de l’illumination apparente de la Lune au cours du cycle.",
      "tradition": "western_astrology"
    },
    {
      "term": "Signe tropical",
      "definition": "Découpage saisonnier du zodiaque utilisé en astrologie occidentale, basé sur l’équinoxe de printemps.",
      "tradition": "western_astrology"
    }
  ],
  "assumptions": "Le vocabulaire utilisateur peut être mixte ; pour éviter le syncrétisme, la réponse est formulée strictement dans un seul cadre (ici : astrologie occidentale tropicale).",
  "clarification": {
    "needs_clarification": false,
    "question": null
  },
  "style_contract": {
    "no_injunction": true,
    "impersonal_tone": true,
    "no_syncretism": true,
    "no_diagnosis": true,
    "no_dogma": true,
    "no_prophecy": true,
    "use_possibility_language": true
  }
}


Règles d’interprétation (côté app)
content.title + content.text = affichage principal.

glossary_and_definitions = affichage secondaire (optionnel).

safety_and_limits.action.mode contrôle si l’app affiche un message spécial (v0: on attend allow la plupart du temps).

style_contract sert à l’audit (Symfony valide aussi, ne pas faire confiance aveuglément au modèle).

5) JSON Schema (fichier à créer)
Fichier : config/ai/schemas/symbolic_weather.schema.json

Contraintes obligatoires :

$schema (draft moderne recommandé : 2020-12)

type: object

additionalProperties: false

required doit inclure au minimum :

meta, routing, safety_and_limits, content, style_contract, data_used

routing.context doit être const: "symbolic_weather"

routing.tradition doit être enum: ["western_astrology"]

meta.language doit être enum: ["fr"] (v0)

safety_and_limits.action.mode enum : ["allow","soft_refusal","refusal","safety_redirect"]

content.text avec min/max length (ex: 80 à 900)

Les sous-objets doivent aussi être additionalProperties:false

6) Prompts versionnés (fichiers à créer)
Les prompts sont stockés dans config/ai/prompts/ pour versionning “par fichier”.

Fichiers requis v0
config/ai/prompts/base_system.md

Règles globales :

JSON strict conforme au schema

pas d’injonctions

pas de syncrétisme

pas de diagnostic médical/juridique

ton impersonnel

mentionner le cadre dans assumptions si vocabulaire utilisateur mixte

config/ai/prompts/contexts/symbolic_weather.md

Style pour symbolic_weather :

métaphores sobres

climat du moment, disponibilité, densité/clarification/rythme

jamais d’ordre ni de “conseil”

config/ai/prompts/traditions/western_astrology.yml

“pack de tradition” (v0 minimal) :

label à utiliser (“astrologie occidentale tropicale”)

liste de termes autorisés

liste de termes interdits (anti-syncrétisme)

règles spécifiques de formulation

7) Appel Ollama (contrat technique)
Configuration
Variables attendues :

OLLAMA_BASE_URL (ex: http://127.0.0.1:11434)

OLLAMA_MODEL (ex: llama3.1:8b)

Requête à envoyer (POST /api/chat)
Payload attendu :

{
  "model": "llama3.1:8b",
  "stream": false,
  "messages": [
    { "role": "system", "content": "base_system + symbolic_weather + règles tradition" },
    { "role": "user", "content": "message utilisateur + lunar_snapshot (formaté en texte)" }
  ],
  "format": { "JSON_SCHEMA_OBJECT": "..." },
  "options": {
    "temperature": 0.4,
    "top_p": 0.9
  }
}
Notes :

format doit recevoir le JSON Schema complet (objet).

La réponse JSON est dans response.message.content (string) → json_decode nécessaire.

8) Workflow exact (exécution v0)
Étapes
Controller reçoit la requête.

DTO Request valide les champs essentiels (lunar_snapshot présent).

Service SymbolicWeatherService :

charge le JSON Schema depuis config/ai/schemas/symbolic_weather.schema.json

charge les prompts (base + context + tradition)

construit system_message + user_message

Appel Ollama via OllamaClient.

Récupère message.content (string).

json_decode → obtient un objet/array.

Validation JSON Schema (Opis) :

si invalide → log + erreur HTTP claire (pas de regen en v0)

Guardrails Symfony :

StyleGuard (anti-injonction) sur content.text

TraditionGuard (anti-syncrétisme) sur content.text + glossary + assumptions

SafetyGuard minimal (structure, flags)

si un guardrail échoue → log + erreur HTTP claire (pas de rewrite en v0)

AiLogService stocke au minimum :

prompt_version/hash (si dispo),

latence,

succès/échec,

raison d’échec,

éventuellement compte tokens si renvoyé par Ollama.

Symfony renvoie le JSON validé.

9) Structure de code Symfony (dossiers + rôle)
src/AI/Controller/
Contrôleurs API de l’IA.

v0 : SymbolicWeatherController.php uniquement.

src/AI/DTO/
Objets de transfert (Request/Response) :

normalisation et validation légère (types/présence).

src/AI/Client/
Clients d’accès LLM (HTTP).

v0 : OllamaClient.php.

LocalLlmClientInterface.php = abstraction future (llama.cpp server etc.).

src/AI/Prompt/
Gestion des prompts versionnés et assemblage :

PromptCatalog lit les fichiers dans config/ai/prompts/.

PromptBuilder compose messages system/user à partir de templates + data.

PromptVersion calcule hash/version (audit).

src/AI/Domain/
Services métier IA.

v0 : SymbolicWeatherService orchestre tout pour symbolic_weather.

src/AI/Guardrails/
Sécurité et qualité :

JsonSchemaValidator : validation JSON Schema via Opis.

StyleGuard : anti-injonction (liste simple v0).

TraditionGuard : anti-syncrétisme lexical (liste simple v0).

SafetyGuard : structure minimal v0.

src/AI/Observability/
Logs et instrumentation :

AiLogService : log minimal v0.

TokenBudget : futur (vide possible v0).

src/AI/Routing/
Routage futur context/tradition (pas en v0).

Fichiers présents pour garder l’architecture stable.

config/ai/
prompts/ : templates versionnés.

schemas/ : JSON Schema.

docs/ai/
Documentation interne stable :

ARCHITECTURE.md reprend ce document.

10) Ce qui est explicitement hors-scope v0
Pas de multi-contextes (autres que symbolic_weather).

Pas de multi-traditions (autres que western_astrology).

Pas de routing automatique.

Pas de rewrite/regen automatique.

Pas de base de connaissances / RAG.

Pas de stockage mémoire utilisateur.

11) Plan de validation (juste après v0)
Créer 2 tests :

JSON valide → passe.

JSON invalide (champ manquant / enum invalide / additionalProperties) → échoue avec erreurs lisibles.

Tester un appel réel Ollama et vérifier que la sortie passe le schema.

FIN

::contentReference[oaicite:0]{index=0}